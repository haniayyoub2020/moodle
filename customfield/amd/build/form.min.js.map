{"version":3,"sources":["../src/form.js"],"names":["confirmDelete","id","type","component","area","itemid","pendingPromise","Pending","then","strings","Notification","confirm","pendingDeletePromise","methodname","args","response","Templates","render","html","js","replaceNode","resolve","catch","exception","createNewCategory","promises","Promise","all","categoryId","window","location","href","getCategoryNameFor","nodeElement","closest","find","attr","setupSortableLists","rootNode","sortCat","SortableList","moveHandlerSelector","getElementName","on","EVENTS","DROP","evt","info","positionChanged","element","data","beforeid","targetNextElement","stopPropagation","sort","getDestinationName","parentElement","afterElement","length","categoryid","targetList","DRAG","querySelectorAll","forEach","category","fields","noFields","querySelector","innerHTML","remove","DRAGSTART","setTimeout","width","init","document","dataset","addEventListener","e","roleHolder","target","role","preventDefault","InplaceEditable"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Custom Field interaction management for Moodle.\n *\n * @module     core_customfield/form\n * @package    core_customfield\n * @copyright  2018 Toni Barbera\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {call as fetchMany} from 'core/ajax';\nimport {\n    get_string as getString,\n    get_strings as getStrings,\n} from 'core/str';\nimport InplaceEditable from 'core/inplace_editable';\nimport Notification from 'core/notification';\nimport Pending from 'core/pending';\nimport SortableList from 'core/sortable_list';\nimport Templates from 'core/templates';\nimport jQuery from 'jquery';\n\n/**\n * Display confirmation dialogue\n *\n * @param {Number} id\n * @param {String} type\n * @param {String} component\n * @param {String} area\n * @param {Number} itemid\n */\nconst confirmDelete = (id, type, component, area, itemid) => {\n    const pendingPromise = new Pending('core_customfield/form:confirmDelete');\n\n    getStrings([\n        {'key': 'confirm'},\n        {'key': 'confirmdelete' + type, component: 'core_customfield'},\n        {'key': 'yes'},\n        {'key': 'no'},\n    ])\n    .then(strings => {\n        return Notification.confirm(strings[0], strings[1], strings[2], strings[3], function() {\n            const pendingDeletePromise = new Pending('core_customfield/form:confirmDelete');\n            fetchMany([\n                {\n                    methodname: (type === 'field') ? 'core_customfield_delete_field' : 'core_customfield_delete_category',\n                    args: {id},\n                },\n                {methodname: 'core_customfield_reload_template', args: {component, area, itemid}}\n            ])[1]\n            .then(response => Templates.render('core_customfield/list', response))\n            .then((html, js) => Templates.replaceNode(jQuery('[data-region=\"list-page\"]'), html, js))\n            .then(pendingDeletePromise.resolve)\n            .catch(Notification.exception);\n        });\n    })\n    .then(pendingPromise.resolve)\n    .catch(Notification.exception);\n};\n\n\n/**\n * Creates a new custom fields category with default name and updates the list\n *\n * @param {String} component\n * @param {String} area\n * @param {Number} itemid\n */\nconst createNewCategory = (component, area, itemid) => {\n    const pendingPromise = new Pending('core_customfield/form:confirmDelete');\n    const promises = fetchMany([\n        {methodname: 'core_customfield_create_category', args: {component: component, area: area, itemid: itemid}},\n        {methodname: 'core_customfield_reload_template', args: {component: component, area: area, itemid: itemid}}\n    ]);\n\n    promises[1].then(response => Templates.render('core_customfield/list', response))\n    .then((html, js) => Templates.replaceNode(jQuery('[data-region=\"list-page\"]'), html, js))\n    .catch(Notification.exception);\n\n    Promise.all(promises)\n    .then(categoryId => {\n        window.location.href = `#category-${categoryId}`;\n        return pendingPromise.resolve();\n    })\n    .catch();\n};\n\n/**\n * Fetch the category name from an inplace editable, given a child node of that field.\n *\n * @param {NodeElement} nodeElement\n * @returns {String}\n */\nconst getCategoryNameFor = nodeElement => nodeElement\n    .closest('[data-category-id]')\n    .find('[data-inplaceeditable][data-itemtype=category][data-component=core_customfield]')\n    .attr('data-value');\n\nconst setupSortableLists = rootNode => {\n    // Sort category.\n    const sortCat = new SortableList(\n        '#customfield_catlist .categorieslist',\n        {\n            moveHandlerSelector: '.movecategory [data-drag-type=move]',\n        }\n    );\n    sortCat.getElementName = nodeElement => Promise.resolve(getCategoryNameFor(nodeElement));\n\n    // Note: The sortable list currently uses jQuery events.\n    jQuery('[data-category-id]').on(SortableList.EVENTS.DROP, (evt, info) => {\n        if (info.positionChanged) {\n            var pendingPromise = new Pending('core_customfield/form:categoryid:on:sortablelist-drop');\n            fetchMany([\n                {\n                    methodname: 'core_customfield_move_category',\n                    args: {\n                        id: info.element.data('category-id'),\n                        beforeid: info.targetNextElement.data('category-id')\n                    }\n\n                },\n            ])[0]\n            .then(pendingPromise.resolve)\n            .catch(Notification.exception);\n        }\n        evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n    });\n\n    // Sort fields.\n    var sort = new SortableList(\n        '#customfield_catlist .fieldslist tbody',\n        {\n            moveHandlerSelector: '.movefield [data-drag-type=move]',\n        }\n    );\n\n    sort.getDestinationName = (parentElement, afterElement) => {\n        if (!afterElement.length) {\n            return getString('totopofcategory', 'customfield', getCategoryNameFor(parentElement));\n        } else if (afterElement.attr('data-field-name')) {\n            return getString('afterfield', 'customfield', afterElement.attr('data-field-name'));\n        } else {\n            return Promise.resolve('');\n        }\n    };\n\n    jQuery('[data-field-name]').on(SortableList.EVENTS.DROP, (evt, info) => {\n        evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n        if (info.positionChanged) {\n            const pendingPromise = new Pending('core_customfield/form:fieldname:on:sortablelist-drop');\n            fetchMany([\n                {\n                    methodname: 'core_customfield_move_field',\n                    args: {\n                        id: info.element.data('field-id'),\n                        beforeid: info.targetNextElement.data('field-id'),\n                        categoryid: Number(info.targetList.closest('[data-category-id]').attr('data-category-id'))\n                    },\n                },\n            ])[0]\n            .then(pendingPromise.resolve)\n            .catch(Notification.exception);\n        }\n    });\n\n    jQuery('[data-field-name]').on(SortableList.EVENTS.DRAG, evt => {\n        var pendingPromise = new Pending('core_customfield/form:fieldname:on:sortablelist-drag');\n\n        evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n\n        // Refreshing fields tables.\n        Templates.render('core_customfield/nofields', {})\n        .then(html => {\n            rootNode.querySelectorAll('.categorieslist > *')\n            .forEach(category => {\n                const fields = category.querySelectorAll('.field:not(.sortable-list-is-dragged)');\n                const noFields = category.querySelector('.nofields');\n\n                if (!fields.length && !noFields) {\n                    category.querySelector('tbody').innerHTML = html;\n                } else if (fields.length && noFields) {\n                    noFields.remove();\n                }\n            });\n            return;\n        })\n        .then(pendingPromise.resolve)\n        .catch(Notification.exception);\n    });\n\n    jQuery('[data-category-id], [data-field-name]').on(SortableList.EVENTS.DRAGSTART, (evt, info) => {\n        setTimeout(() => {\n            jQuery('.sortable-list-is-dragged').width(info.element.width());\n        }, 501);\n    });\n\n};\n\n/**\n * Initialise the custom fields manager.\n */\nexport const init = () => {\n    const rootNode = document.querySelector('#customfield_catlist');\n\n    const component = rootNode.dataset.component;\n    const area = rootNode.dataset.area;\n    const itemid = rootNode.dataset.itemid;\n\n    rootNode.addEventListener('click', e => {\n        const roleHolder = e.target.closest('[data-role]');\n        if (!roleHolder) {\n            return;\n        }\n\n        if (roleHolder.dataset.role === 'deletefield') {\n            e.preventDefault();\n\n            confirmDelete(roleHolder.dataset.id, 'field', component, area, itemid);\n            return;\n        }\n\n        if (roleHolder.dataset.role === 'deletecategory') {\n            e.preventDefault();\n\n            confirmDelete(roleHolder.dataset.id, 'category', component, area, itemid);\n            return;\n        }\n\n        if (roleHolder.dataset.role === 'addnewcategory') {\n            e.preventDefault();\n            createNewCategory(component, area, itemid);\n\n            return;\n        }\n\n    });\n\n    setupSortableLists(rootNode, component, area, itemid);\n    InplaceEditable.init();\n};\n"],"file":"form.min.js"}